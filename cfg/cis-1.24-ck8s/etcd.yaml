---
controls:
version: "cis-1.24"
id: 2
text: "Etcd Node Configuration"
type: "etcd"
groups:
  - id: 2
    text: "Etcd Node Configuration"
    checks:
      - id: 2.1
        text: "Ensure that the ETCD_CERT_FILE and ETCD_KEY_FILE environment variables are set as appropriate (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          bin_op: and
          test_items:
            - env: "ETCD_CERT_FILE"
            - env: "ETCD_KEY_FILE"
        remediation: |
          Follow the etcd service documentation and configure TLS encryption.
          Then, edit the etcd daemon configuration file $etcdconf
          on the master node and set the below variables.
          ETCD_CERT_FILE=</path/to/ca-file>
          ETCD_KEY_FILE=</path/to/key-file>
        scored: true

      - id: 2.2
        text: "Ensure that the ETCD_CLIENT_CERT_AUTH variable is set to true (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          test_items:
            - env: "ETCD_CLIENT_CERT_AUTH"
              compare:
                op: eq
                value: true
        remediation: |
          Edit the etcd daemon configuration file $etcdconf on the master
          node and set the below variable.
          ETCD_CLIENT_CERT_AUTH=true
        scored: true

      - id: 2.3
        text: "Ensure that the ETCD_AUTO_TLS argument is not set to true (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          bin_op: or
          test_items:
            - env: "ETCD_AUTO_TLS"
              set: false
            - env: "ETCD_AUTO_TLS"
              compare:
                op: eq
                value: false
        remediation: |
          Edit the etcd daemon configuration file $etcdconf on the master
          node and either remove the ETCD_AUTO_TLS variable or set it to false.
            ETCD_AUTO_TLS=false
        scored: true

      - id: 2.4
        text: "Ensure that the ETCD_PEER_CERT_FILE and ETCD_PEER_KEY_FILE variables are
        set as appropriate (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          bin_op: and
          test_items:
            - env: "ETCD_PEER_CERT_FILE"
            - env: "ETCD_PEER_KEY_FILE"
        remediation: |
          Follow the etcd service documentation and configure peer TLS encryption as appropriate
          for your etcd cluster.
          Then, edit the etcd daemon configuration file $etcdconf on the
          master node and set the below variables.
          ETCD_PEER_CERT_FILE=</path/to/peer-cert-file>
          ETCD_PEER_KEY_FILE=</path/to/peer-key-file>
        scored: true

      - id: 2.5
        text: "Ensure that the ETCD_PEER_CLIENT_CERT_AUTH variable is set to true (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          test_items:
            - env: "ETCD_PEER_CLIENT_CERT_AUTH"
              compare:
                op: eq
                value: true
        remediation: |
          Edit the etcd daemon configuration file $etcdconf on the master
          node and set the below parameter.
          ETCD_PEER_CLIENT_CERT_AUTH=true
        scored: true

      - id: 2.6
        text: "Ensure that the ETCD_PEER_AUTO_TLS argument is not set to true (Automated)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          bin_op: or
          test_items:
            - env: "ETCD_PEER_AUTO_TLS"
              set: false
            - env: "ETCD_PEER_AUTO_TLS"
              compare:
                op: eq
                value: false
        remediation: |
          Edit the etcd daemon configuration file $etcdconf on the master
          node and either remove the ETCD_PEER_AUTO_TLS parameter or set it to false.
          ETCD_PEER_AUTO_TLS=false
        scored: true

      - id: 2.7
        text: "Ensure that a unique Certificate Authority is used for etcd (Manual)"
        audit: "cat /proc/$(pidof $etcdbin)/environ"
        tests:
          test_items:
            - env: "ETCD_TRUSTED_CA_FILE"
        remediation: |
          Follow the etcd documentation and create a dedicated certificate authority setup for the
          etcd service.
          Then, edit the etcd daemon configuration file $etcdconf on the
          master node and set the below parameter.
          ETCD_TRUSTED_CA_FILE=</path/to/ca-file>
        scored: false
